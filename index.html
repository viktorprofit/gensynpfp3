<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PFP Item Forge</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#121212;
      --line:#3a1a12;
      --accent:#fad7d1;
      --accent-2:#f3c2b9;
      --accent-3:#ffc9be;
      --text:#ffffff;
      --muted:#d7b9b3;
      --deep-brown:#230800;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background:url('items/background.png') no-repeat center center fixed;
      background-size:cover;
    }

    .wrap{
      max-width:1100px;
      margin:28px auto;
      padding:0 16px;
      display:grid;
      gap:20px;
      grid-template-columns:1fr;
    }
    @media(min-width:1100px){.wrap{grid-template-columns:1.2fr .9fr}}

    /* ==== FRAME / CANVAS ==== */
    .stage{
      position:relative;
      background:linear-gradient(180deg,#111,#0f0f0f);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      display:flex;
      justify-content:center;
      align-items:center;
    }

    canvas{
      width:85%;
      background:#0a0a0a;
      border:1px dashed rgba(250,215,209,.35);
      border-radius:12px;
      display:block;
    }

    /* ==== PANELS ==== */
    .panel{
      background:linear-gradient(180deg,#121212,#111);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      font-size:0.95em;
    }
    .panel + .panel{margin-top:10px}

    .title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;letter-spacing:.01em}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 3px rgba(250,215,209,.25)}
    .muted{color:var(--muted);font-size:12px}

    /* ==== BUTTONS ==== */
    .btn{
      appearance:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      background:#1a1f2e;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px 14px;
      font-weight:600;
      font-size:16px;
      cursor:pointer;
      transition:filter .25s ease,box-shadow .25s ease,background .25s ease,transform .08s ease;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      border:0;
      color:var(--deep-brown);
    }
    .btn.primary:hover{
      background:linear-gradient(90deg,var(--accent-3),var(--accent));
      filter:brightness(1.03);
      box-shadow:0 8px 26px rgba(250,215,209,.20),0 0 0 1px rgba(250,215,209,.25) inset;
    }

    /* ==== THUMBS ==== */
    .thumbs{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-top:8px;
    }
    .thumb{
      background:#141414;
      border:2px solid var(--line);
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:70px;
      cursor:pointer;
      transition:border-color .25s ease,box-shadow .25s ease,background .25s ease;
    }
    .thumb img{max-width:90%;object-fit:contain}
    .thumb:hover{border-color:var(--accent);box-shadow:0 0 10px 2px rgba(250,215,209,0.25);background:#151515}
    .thumb.active{border-color:var(--accent);box-shadow:0 0 14px 3px rgba(250,215,209,0.4)}

    /* ==== CONTROLS ==== */
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    input[type="range"]{width:100%;accent-color:var(--accent)}
    label{display:block;margin:6px 0;color:var(--muted)}
    .bar{display:flex;gap:10px;margin-top:10px}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="stage" aria-label="Preview Stage">
      <canvas id="c" width="900" height="900"></canvas>
    </section>

    <section>
      <div class="panel">
        <div class="title"><span class="dot"></span> Upload PFP</div>
        <p class="muted" style="margin:8px 0 12px">PNG / JPG / WEBP — rendered locally.</p>
        <input id="photo" type="file" accept="image/png,image/jpeg,image/webp" style="display:none"/>
        <button id="pickPhoto" class="btn primary">⬆ Select PFP File</button>
      </div>

      <div class="panel">
        <div class="title"><span class="dot"></span> Select Item</div>
        <div class="thumbs" id="thumbs">
          <button class="thumb" data-mask="cap1"><img src="items/cap-a.png" alt="Cap A"/></button>
          <button class="thumb" data-mask="cap2"><img src="items/cap-b.png" alt="Cap B"/></button>
          <button class="thumb" data-mask="bucket"><img src="items/bucket-hat.png" alt="Bucket Hat"/></button>
          <button class="thumb" data-mask="cap3"><img src="items/cap-c.png" alt="Cap C"/></button>
          <button class="thumb" data-mask="cap4"><img src="items/cap-d.png" alt="Cap D"/></button>
          <button class="thumb" data-mask="cap5"><img src="items/cap-e.png" alt="Cap E"/></button>
        </div>

        <div class="row">
          <div>
            <label for="scale">Scale</label>
            <input id="scale" type="range" min="0.2" max="3" value="1" step="0.01"/>
          </div>
          <div>
            <label for="rotate">Rotate (°)</label>
            <input id="rotate" type="range" min="-180" max="180" value="0" step="1"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="opacity">Opacity</label>
            <input id="opacity" type="range" min="0" max="1" value="1" step="0.01"/>
          </div>
        </div>

        <div class="bar">
          <button id="download" class="btn primary">⬇ Download PNG</button>
          <button id="reset" class="btn">↻ Reset</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const canvas=document.getElementById('c');
    const ctx=canvas.getContext('2d');
    const photoInput=document.getElementById('photo');
    const pickPhotoBtn=document.getElementById('pickPhoto');
    const thumbs=document.getElementById('thumbs');
    const scaleInput=document.getElementById('scale');
    const rotateInput=document.getElementById('rotate');
    const opacityInput=document.getElementById('opacity');
    const resetBtn=document.getElementById('reset');
    const dlBtn=document.getElementById('download');

    pickPhotoBtn.addEventListener('click',()=>photoInput.click());
    const state={bgImg:null,capImg:null,cap:{x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1}};
    const itemPaths={
      cap1:'items/cap-a.png',
      cap2:'items/cap-b.png',
      bucket:'items/bucket-hat.png',
      cap3:'items/cap-c.png',
      cap4:'items/cap-d.png',
      cap5:'items/cap-e.png'
    };
    const presets={};
    Object.entries(itemPaths).forEach(([k,src])=>{const i=new Image();i.src=src;presets[k]=i;});

    function loadImageFromFile(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>{
          const img=new Image();
          img.onload=()=>resolve(img);
          img.onerror=()=>reject(new Error('decode failed'));
          img.src=reader.result;
        };
        reader.onerror=()=>reject(new Error('read failed'));
        reader.readAsDataURL(file);
      });
    }
    function fitCanvasToImage(img){
      const MAX=1400;let w=img.naturalWidth,h=img.naturalHeight;
      const k=Math.min(1,MAX/Math.max(w,h));
      canvas.width=Math.round(w*k);canvas.height=Math.round(h*k);
    }
    function centerCap(imgLike){
      const iw=imgLike.width||imgLike.naturalWidth;
      const ih=imgLike.height||imgLike.naturalHeight;
      state.cap.w=iw;state.cap.h=ih;
      state.cap.scale=Math.min(1,canvas.width/iw*0.5);
      state.cap.rot=0;
      state.cap.x=canvas.width/2-(iw*state.cap.scale)/2;
      state.cap.y=canvas.height*0.2;
      scaleInput.value=String(state.cap.scale);
      rotateInput.value=String(state.cap.rot);
    }
    function render(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(state.bgImg){ctx.drawImage(state.bgImg,0,0,canvas.width,canvas.height);}
      else{ctx.fillStyle='#0a0a0a';ctx.fillRect(0,0,canvas.width,canvas.height);}
      if(state.capImg){
        const {x,y,w,h,scale,rot,alpha}=state.cap;
        const cw=w*scale,ch=h*scale;
        const cx=x+cw/2,cy=y+ch/2;
        ctx.save();ctx.translate(cx,cy);ctx.rotate(rot*Math.PI/180);ctx.globalAlpha=alpha;
        ctx.drawImage(state.capImg,-cw/2,-ch/2,cw,ch);
        ctx.restore();ctx.globalAlpha=1;
      }
    }
    photoInput.addEventListener('change',async()=>{
      const f=photoInput.files?.[0];if(!f)return;
      try{
        const img=await loadImageFromFile(f);
        state.bgImg=img;fitCanvasToImage(img);render();
      }catch(e){alert('Unsupported format.');}
    });
    thumbs.addEventListener('click',e=>{
      const box=e.target.closest('.thumb');if(!box)return;
      const key=box.getAttribute('data-mask');if(!key)return;
      state.capImg=presets[key];
      centerCap(state.capImg);
      document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));
      box.classList.add('active');
      render();
    });
    scaleInput.addEventListener('input',()=>{state.cap.scale=parseFloat(scaleInput.value||'1');render();});
    rotateInput.addEventListener('input',()=>{state.cap.rot=parseFloat(rotateInput.value||'0');render();});
    opacityInput.addEventListener('input',()=>{state.cap.alpha=parseFloat(opacityInput.value||'1');render();});
    resetBtn.addEventListener('click',()=>{state.capImg=null;document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));render();});
    dlBtn.addEventListener('click',()=>{
      const link=document.createElement('a');
      link.download='pfp.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
    render();
  </script>
</body>
</html>
